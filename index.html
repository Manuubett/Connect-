<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CONNECT HUB.</title>
  <meta name="title" content="Life After Campus — Connect with Undergraduate & Graduate Students Worldwide">
  <meta name="description" content="Join a global community where undergraduate and graduate students and alumni from all over the world meet, share real stories, exchange ideas, and interact. Discover careers, life lessons, and build lifelong connections beyond campus.">

  <meta name="keywords" content="global student community, undergraduate graduates worldwide, share ideas with students, connect with alumni, life after campus, student success, campus stories, career advice students, international student network, university graduates connect">
  <meta name="author" content="Life After Campus">
  <meta name="robots" content="index, follow">

  <!-- Open Graph / Twitter -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://compus.bettke.space/">
  <meta property="og:title" content="Life After Campus — Meet & Connect with Students and Graduates Worldwide">
  <meta property="og:description" content="A global platform where undergraduate and graduate students and alumni from every corner of the world come together to share real stories, ideas, career insights, and build meaningful connections.">
  <meta property="og:image" content="https://manuubett.github.io/Compus/cover.png">
  <meta property="og:site_name" content="Life After Campus">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://compus.bettke.space/">
  <meta name="twitter:title" content="Life After Campus — Global Community for Students & Graduates">
  <meta name="twitter:description" content="Meet undergraduate and graduate students/alumni from all over the world. Share ideas, real stories, career tips, and interact in a supportive global community.">
  <meta name="twitter:image" content="https://manuubett.github.io/Compus/cover.png">

  <meta property="og:locale" content="en_US">
  <link rel="canonical" href="https://compus.bettke.space/">

  <!-- FAVICON -->
  <link rel="icon" type="image/png" href="https://manuubett.github.io/Compus/cover.png">
  <link rel="shortcut icon" href="https://manuubett.github.io/Compus/cover.png">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
  <source src="notify.mp3" type="audio/mpeg">
<source src="notify.ogg" type="audio/ogg">

  <style>
    :root {
      --blue: #0066ff;
      --light-blue: #e6f0ff;
      --light: #f8faff;
      --gray: #666;
      --light-gray: #e0e0e0;
      --dark-gray: #444;
      --bg: #f0f4f9;
      --white: #ffffff;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --radius: 12px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg);
      color: #222;
      line-height: 1.6;
    }

    header {
      background: var(--blue);
      color: #fff;
      padding: 20px;
      text-align: center;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    nav {
      display: flex;
      justify-content: space-around;
      background: #fff;
      padding: 12px 0;
      border-bottom: 1px solid #ddd;
      position: sticky;
      top: 0;
      z-index: 50;
    }
    nav a {
      color: var(--gray);
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s;
    }
    nav a:hover { color: var(--blue); }

    .container {
      max-width: 900px;
      margin: 20px auto;
      padding: 0 15px;
    }

    .welcome {
      background: #fff;
      border-radius: var(--radius);
      padding: 25px;
      box-shadow: var(--shadow);
      text-align: center;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .welcome h2 { color: var(--blue); margin-bottom: 5px; }

    .profile-pic {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 15px;
      border: 3px solid var(--blue);
    }

    #searchBar {
      width: 100%;
      padding: 14px 20px;
      border-radius: 30px;
      border: 1px solid var(--light-gray);
      margin-bottom: 20px;
      font-size: 1rem;
      background: var(--white);
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      transition: all 0.3s;
    }
    #searchBar:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 2px 8px rgba(0,102,255,0.15);
    }

    .post-box {
      background: var(--white);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
      transition: transform 0.2s;
    }
    .post-box:hover {
      transform: translateY(-2px);
    }
    .post-box textarea {
      width: 100%;
      border: 1px solid var(--light-gray);
      border-radius: 10px;
      padding: 15px;
      font-family: inherit;
      resize: none;
      font-size: 1rem;
      transition: border 0.3s;
    }
    .post-box textarea:focus {
      outline: none;
      border-color: var(--blue);
    }
    .post-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
    }
    .file-upload {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .file-upload label {
      color: var(--gray);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: color 0.3s;
    }
    .file-upload label:hover {
      color: var(--blue);
    }
    .post-box button {
      background: var(--blue);
      color: #fff;
      border: none;
      padding: 10px 22px;
      border-radius: 30px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .post-box button:hover {
      background: #0052cc;
      transform: translateY(-2px);
    }

    .feed .post {
      background: var(--white);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      transition: transform 0.3s;
    }
    .feed .post:hover {
      transform: translateY(-3px);
    }

    .post-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
    }

    .post-header img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
    }

    .post-user-info h4 {
      margin: 0;
      color: var(--dark-gray);
    }
    .post-user-info p {
      margin: 0;
      color: var(--gray);
      font-size: 0.85rem;
    }

    .post-content {
      margin-bottom: 15px;
    }
    .post-content p {
      margin-bottom: 10px;
    }

    .post-image {
      width: 100%;
      border-radius: 10px;
      margin-top: 10px;
      max-height: 400px;
      object-fit: cover;
      cursor: pointer;
      transition: transform 0.3s;
    }
    .post-image:hover {
      transform: scale(1.01);
    }

    .post-time {
      color: var(--gray);
      font-size: 0.8rem;
      margin-top: 5px;
    }

    .post-stats {
      display: flex;
      justify-content: space-between;
      color: var(--gray);
      font-size: 0.85rem;
      padding: 10px 0;
      border-top: 1px solid var(--light-gray);
      border-bottom: 1px solid var(--light-gray);
      margin: 15px 0;
    }

    .post-actions-buttons {
      display: flex;
      justify-content: space-around;
      margin-top: 10px;
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
      color: var(--gray);
    }
    .action-btn:hover {
      background: var(--light-blue);
      color: var(--blue);
    }
    .action-btn.liked {
      color: #e74c3c;
    }

    .comment-box {
      margin-top: 15px;
      border-top: 1px solid var(--light-gray);
      padding-top: 15px;
    }

    .comment-input {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .comment-input img {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      object-fit: cover;
    }
    .comment-input input {
      flex: 1;
      padding: 10px 15px;
      border-radius: 20px;
      border: 1px solid var(--light-gray);
      font-size: 0.9rem;
    }
    .comment-input input:focus {
      outline: none;
      border-color: var(--blue);
    }

    .comment {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      padding: 12px;
      border-radius: 10px;
      background: var(--light);
    }
    .comment img {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      object-fit: cover;
    }
    .comment-content {
      flex: 1;
    }
    .comment-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    .comment-header h5 {
      margin: 0;
      color: var(--dark-gray);
    }
    .comment-header span {
      color: var(--gray);
      font-size: 0.8rem;
    }
    .comment-text {
      margin-bottom: 5px;
    }
    .comment-actions {
      display: flex;
      gap: 15px;
      font-size: 0.8rem;
    }
    .comment-action {
      color: var(--gray);
      cursor: pointer;
      transition: color 0.3s;
    }
    .comment-action:hover {
      color: var(--blue);
    }

    .replies {
      margin-left: 45px;
      margin-top: 10px;
    }

    .reply {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 10px;
      background: var(--light);
    }

    .no-posts {
      text-align: center;
      color: var(--gray);
      padding: 40px 20px;
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .no-posts i {
      font-size: 3rem;
      margin-bottom: 15px;
      color: var(--light-gray);
    }

    footer {
      text-align: center;
      padding: 20px;
      color: var(--gray);
      font-size: 0.85rem;
      margin-top: 30px;
    }

    /* Modal for image viewing */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      max-width: 90%;
      max-height: 90%;
    }
    .modal-close {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 2rem;
      cursor: pointer;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .container {
        padding: 0 10px;
      }
      .post-actions-buttons {
        flex-direction: column;
        gap: 5px;
      }
      .action-btn {
        justify-content: center;
      }
    }
  </style>
  <style>
/* Modern gradient background */
#mainNav {
  background: linear-gradient(135deg, #4361ee, #5a67ff, #7c3aed);
  padding: 12px 20px;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
  position: sticky;
  top: 0;
  z-index: 1000;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  backdrop-filter: blur(6px);
}

/* Link styling */
#mainNav a {
  color: #ffffff;
  font-weight: 600;
  text-decoration: none;
  font-size: 15px;
  transition: 0.2s ease-in-out;
}

#mainNav a:hover {
  opacity: 0.85;
  transform: scale(1.04);
}

/* Bell icon hover */
#notifBell i:hover {
  transform: scale(1.2);
  transition: 0.2s;
}

/* Notification dropdown */
#notifDropdown {
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

/* The rest of your existing notification CSS stays unchanged */
</style>
</head>
<body>

<header>
  <h1>FollowUp Connect</h1>
  <p>Professional Community of Graduates & Mentors</p>
</header>

  <!-- FLOATING APK DOWNLOAD BUTTON -->

<style>
  #apkButton {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #4361ee;
    color: #fff;
    padding: 14px 18px;
    font-size: 15px;
    font-weight: 600;
    border-radius: 50px;
    text-decoration: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.25);
    z-index: 9999;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }

  #apkButton:hover {
    transform: scale(1.08);
  }
</style>

  <!-- ===== NAVIGATION ===== -->
<nav id="mainNav" style="background:#4361ee;padding:12px 20px;display:flex;justify-content:center;align-items:center;gap:20px;flex-wrap:wrap;position:sticky;top:0;z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,0.1);">
  <a href="compus home.html"><i class="fas fa-home"></i> Home</a>
  <a href="network.html"><i class="fas fa-users"></i> Network</a>
  <a href="opportunity.html"><i class="fas fa-briefcase"></i> Opportunities</a>
  <a href="chat.html"><i class="fas fa-comments"></i> Chats</a>
  <a href="compus profile.html"><i class="fas fa-user"></i> Profile</a>

  <!-- Notification Bell with Badge -->
  <div id="notifBellWrapper" style="margin-left:auto;position:relative;">
    <a href="#" id="notifBell">
      <i class="fas fa-bell" style="font-size:18px;"></i>
      <span id="notifBadge" style="position:absolute;top:-8px;right:-8px;background:#ef4444;color:white;font-size:11px;font-weight:700;padding:2px 6px;border-radius:12px;min-width:16px;text-align:center;display:none;">0</span>
    </a>
    <!-- Dropdown panel -->
    <div id="notifDropdown" style="display:none;position:absolute;right:0;top:36px;width:320px;background:white;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.1);overflow:hidden;z-index:2000;max-height:400px;overflow-y:auto;">
      <div style="padding:12px;font-weight:600;border-bottom:1px solid #e2e8f0;background:#f8f9fc;">Notifications</div>
      <div id="notifList"></div>
      <div id="notifEmpty" style="padding:20px;text-align:center;color:#94a3b8;">No new notifications</div>
    </div>
  </div>
</nav>
<div id="postsContainer"></div>
<!-- Notification Sound -->
<audio id="notifSound" preload="auto">
  <source src="new-notification-021-370045.mp3" type="audio/mpeg">
</audio>

<script>
const notifSound = document.getElementById("notifSound");

// Log when the audio is loaded
notifSound.onloadeddata = () => {
  console.log("Sound loaded successfully.");
};

// Function to play sound with console logs
function playNotificationSound() {
  console.log("Attempting to play notification sound...");

  notifSound.play()
    .then(() => {
      console.log("Notification sound is playing.");
    })
    .catch(err => {
      console.error("Error playing sound:", err);
    });
}
</script>
<style>
/* Bell shake */
@keyframes fa-shake {
  0% { transform: rotate(0deg); }
  10% { transform: rotate(-15deg); }
  20% { transform: rotate(15deg); }
  30% { transform: rotate(-15deg); }
  40% { transform: rotate(15deg); }
  50% { transform: rotate(-10deg); }
  60% { transform: rotate(10deg); }
  70% { transform: rotate(-5deg); }
  80% { transform: rotate(5deg); }
  90% { transform: rotate(0deg); }
  100% { transform: rotate(0deg); }
}
.fa-shake { animation: fa-shake 0.8s ease-in-out; display:inline-block; color:#fff !important; }

/* Notification items */
#notifList .notificationItem { display:flex;align-items:center;padding:10px 12px;border-bottom:1px solid #e2e8f0;cursor:pointer;transition:background 0.2s; }
#notifList .notificationItem:hover { background:#f1f5ff; }
#notifList .notificationItem img { width:40px;height:40px;border-radius:50%;object-fit:cover;margin-right:12px; }
#notifList .notificationContent { flex:1; }
#notifList .notificationTitle { font-weight:600;color:#1e293b; }
#notifList .notificationMsg { font-size:0.9rem;color:#64748b; }
#notifList .notificationTime { font-size:0.75rem;color:#94a3b8;margin-top:4px; }
#notifList .notifActions { display:flex;gap:6px;margin-left:6px; }
#notifList .btn-small { padding:4px 8px;border:none;border-radius:6px;font-size:0.75rem;font-weight:600;cursor:pointer; }
#notifList .btnAccept { background:#dcfce7;color:#166534; }
#notifList .btnDecline { background:#fee2e2;color:#991b1b; }
</style>


<div class="container">
  <div class="welcome">
    <img id="userPic" class="profile-pic" src="https://via.placeholder.com/80" alt="Profile Photo">
    <h2>Welcome, <span id="userName">...</span></h2>
    <p><span id="userCampus"></span></p>
    <p>Share your story, connect, and grow together.</p>
  </div>

  <input type="text" id="searchBar" placeholder="Search posts, users, or campus..." />

  <div class="post-box">
    <textarea id="postInput" rows="3" placeholder="Share your career journey, achievements, or ask a question..."></textarea>
    <div class="post-actions">
      <div class="file-upload">
        <label for="fileInput">
          <i class="fas fa-image"></i> Photo
        </label>
        <input type="file" id="fileInput" accept="image/*" style="display: none;" />
      </div>
      <button id="postBtn">
        <i class="fas fa-paper-plane"></i> Post
      </button>
    </div>
  </div>

  <div class="feed" id="feed"></div>
</div>

<!-- Modal for image viewing -->
<div class="modal" id="imageModal">
  <span class="modal-close" id="modalClose">&times;</span>
  <img class="modal-content" id="modalImage">
</div>

<footer>
  © 2025 FollowUp Connect — Inspire • Connect • Grow
</footer>

<script>
  // === Firebase Config ===
  const firebaseConfig = {
    apiKey: "AIzaSyC23iQpw8dvOamO5FpcrWWlgTwJ8gvmuM4",
    authDomain: "reconnect-10733.firebaseapp.com",
    projectId: "reconnect-10733",
    storageBucket: "reconnect-10733.firebasestorage.app",
    messagingSenderId: "902709752297",
    appId: "1:902709752297:web:b89e694688d25472ac1b78"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const feed = document.getElementById("feed");
  const searchBar = document.getElementById("searchBar");
  const imageModal = document.getElementById("imageModal");
  const modalImage = document.getElementById("modalImage");
  const modalClose = document.getElementById("modalClose");

  let currentUser = null;

  auth.onAuthStateChanged(async user => {
    if (!user) return (window.location.href = "login5.html");
    const userDoc = await db.collection("users").doc(user.uid).get();

    if (!userDoc.exists || !userDoc.data().name || !userDoc.data().campus) {
      // redirect to profile setup if incomplete
      return window.location.href = "compus profile.html";
    }

    currentUser = { uid: user.uid, ...userDoc.data() };
    document.getElementById("userName").textContent = currentUser.name;
    document.getElementById("userCampus").textContent = currentUser.campus;
    document.getElementById("userPic").src = currentUser.photoUrl || "https://via.placeholder.com/80";
    loadPosts();
  });

  // Modal functionality
  modalClose.onclick = function() {
    imageModal.style.display = "none";
  }

  window.onclick = function(event) {
    if (event.target == imageModal) {
      imageModal.style.display = "none";
    }
  }
  function openImageModal(src) {
    modalImage.src = src;
    imageModal.style.display = "flex";
  }

  async function uploadToImgbb(file) {
    const apiKey = "05163a0dd1a27a6334b22abb1d279bec";
    const formData = new FormData();
    formData.append("image", file);
    const res = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, { method: "POST", body: formData });
    const data = await res.json();
    return data.data.url;
  }

  document.getElementById("postBtn").onclick = async () => {
    const text = document.getElementById("postInput").value.trim();
    const file = document.getElementById("fileInput").files[0];
    if (!text && !file) return alert("Write something or attach a photo");

    let imageUrl = "";
    if (file) imageUrl = await uploadToImgbb(file);

    await db.collection("posts").add({
      uid: currentUser.uid,
      author: currentUser.name,
      campus: currentUser.campus,
      profilePic: currentUser.photoUrl || "",
      text,
      imageUrl,
      likes: [],
      comments: [],
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    document.getElementById("postInput").value = "";
    document.getElementById("fileInput").value = "";
    loadPosts();
  };

  async function loadPosts() {
    feed.innerHTML = "<div class='no-posts'><i class='fas fa-spinner fa-spin'></i><p>Loading posts...</p></div>";
    const snap = await db.collection("posts").orderBy("createdAt", "desc").get();
    feed.innerHTML = "";

    if (snap.empty) {
      feed.innerHTML = "<div class='no-posts'><i class='far fa-comment-dots'></i><p>No posts yet. Be the first to share your story!</p></div>";
      return;
    }

    snap.forEach(doc => {
      const post = doc.data();
      const div = document.createElement("div");
      div.className = "post";

      // Format post time
      let postTime = "";
      if (post.createdAt) {
        const date = post.createdAt.toDate();
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) {
          postTime = "Just now";
        } else if (diffMins < 60) {
          postTime = `${diffMins} min ago`;
        } else if (diffHours < 24) {
          postTime = `${diffHours} hr ago`;
        } else if (diffDays < 7) {
          postTime = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        } else {
          postTime = date.toLocaleDateString();
        }
      }

      // Get comment count
      let commentCount = 0;
      if (post.comments) {
        commentCount = post.comments.length;
        // Also count replies
        post.comments.forEach(comment => {
          if (comment.replies) {
            commentCount += comment.replies.length;
          }
        });
      }

      div.innerHTML = `
        <div class="post-header">
          <img src="${post.profilePic || 'https://via.placeholder.com/50'}" alt="Profile"/>
          <div class="post-user-info">
            <h4>${post.author || "Anonymous"}</h4>
            <p>${post.campus || ""} • ${postTime}</p>
          </div>
        </div>
        <div class="post-content">
          <p>${post.text}</p>
          ${post.imageUrl ? `<img src="${post.imageUrl}" class="post-image" onclick="openImageModal('${post.imageUrl}')" loading="lazy" alt="post image"/>` : ""}
        </div>
        <div class="post-stats">
          <span>${post.likes?.length || 0} likes</span>
          <span>${commentCount} comments</span>
        </div>
        <div class="post-actions-buttons">
          <div class="action-btn ${post.likes?.includes(currentUser.uid) ? 'liked' : ''}" onclick="likePost('${doc.id}')">
            <i class="fas fa-heart"></i> Like
          </div>
          <div class="action-btn" onclick="toggleComments('${doc.id}')">
            <i class="fas fa-comment"></i> Comment
          </div>
          <div class="action-btn">
            <i class="fas fa-share"></i> Share
          </div>
        </div>
        <div id="comments-${doc.id}" class="comment-box" style="display:none;">
          <div class="comment-input">
            <img src="${currentUser.photoUrl || 'https://via.placeholder.com/35'}" alt="Your profile" />
            <input type="text" placeholder="Write a comment..." id="commentInput-${doc.id}" />
          </div>
          <button style="margin-bottom:15px;" onclick="addComment('${doc.id}')">Post Comment</button>
          <div id="commentList-${doc.id}"></div>
        </div>
      `;
      feed.appendChild(div);
      loadComments(doc.id);
    });
  }
  function displayPosts(posts) {
  const container = document.getElementById('postsContainer');
  container.innerHTML = ''; // Clear old posts

  posts.forEach(post => {
    const div = document.createElement('div');
    div.className = 'post';
    div.innerHTML = `
      <h3>${post.title}</h3>
      <p>${post.content}</p>
    `;
    container.appendChild(div);
  });
}

  async function likePost(id) {
    const postRef = db.collection("posts").doc(id);
    const doc = await postRef.get();
    const data = doc.data();
    const likes = data.likes || [];
    const hasLiked = likes.includes(currentUser.uid);
    const newLikes = hasLiked ? likes.filter(l => l !== currentUser.uid) : [...likes, currentUser.uid];
    await postRef.update({ likes: newLikes });
    loadPosts();
  }

  async function loadComments(postId) {
    const list = document.getElementById(`commentList-${postId}`);
    const snap = await db.collection("posts").doc(postId).collection("comments").orderBy("createdAt", "asc").get();
    list.innerHTML = "";
    
    if (snap.empty) {
      list.innerHTML = "<p style='text-align:center;color:#888;font-size:0.9rem;'>No comments yet. Be the first to comment!</p>";
      return;
    }
    
    snap.forEach(doc => {
      const c = doc.data();
      const commentTime = c.createdAt ? c.createdAt.toDate().toLocaleDateString() : "";
      
      const div = document.createElement("div");
      div.className = "comment";
      div.innerHTML = `
        <img src="${c.authorPhoto || 'https://via.placeholder.com/35'}" alt="Commenter profile" />
        <div class="comment-content">
          <div class="comment-header">
            <h5>${c.author}</h5>
            <span>${commentTime}</span>
          </div>
          <div class="comment-text">${c.text}</div>
          <div class="comment-actions">
            <span class="comment-action" onclick="toggleReplyInput('${postId}', '${doc.id}')">Reply</span>
          </div>
          <div id="reply-input-${postId}-${doc.id}" class="comment-input" style="display:none; margin-top:10px;">
            <img src="${currentUser.photoUrl || 'https://via.placeholder.com/35'}" alt="Your profile" />
            <input type="text" placeholder="Write a reply..." id="replyInput-${postId}-${doc.id}" />
            <button onclick="addReply('${postId}', '${doc.id}')">Reply</button>
          </div>
          <div id="replies-${postId}-${doc.id}" class="replies"></div>
        </div>
      `;
      list.appendChild(div);
      loadReplies(postId, doc.id);
    });
  }

  async function loadReplies(postId, commentId) {
    const repliesContainer = document.getElementById(`replies-${postId}-${commentId}`);
    const snap = await db.collection("posts").doc(postId).collection("comments").doc(commentId).collection("replies").orderBy("createdAt", "asc").get();
    repliesContainer.innerHTML = "";
    
    snap.forEach(doc => {
      const r = doc.data();
      const replyTime = r.createdAt ? r.createdAt.toDate().toLocaleDateString() : "";
      
      const replyDiv = document.createElement("div");
      replyDiv.className = "reply";
      replyDiv.innerHTML = `
        <img src="${r.authorPhoto || 'https://via.placeholder.com/35'}" alt="Replier profile" />
        <div>
          <div style="display:flex; justify-content:space-between;">
            <h5 style="margin:0;">${r.author}</h5>
            <span style="color:#888; font-size:0.8rem;">${replyTime}</span>
          </div>
          <div>${r.text}</div>
        </div>
      `;
      repliesContainer.appendChild(replyDiv);
    });
  }

  async function addComment(postId) {
    const input = document.getElementById(`commentInput-${postId}`);
    const text = input.value.trim();
    if (!text) return;
    await db.collection("posts").doc(postId).collection("comments").add({
      author: currentUser.name,
      authorPhoto: currentUser.photoUrl || "",
      text,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    input.value = "";
    loadComments(postId);
  }

  async function addReply(postId, commentId) {
    const input = document.getElementById(`replyInput-${postId}-${commentId}`);
    const text = input.value.trim();
    if (!text) return;
    await db.collection("posts").doc(postId).collection("comments").doc(commentId).collection("replies").add({
      author: currentUser.name,
      authorPhoto: currentUser.photoUrl || "",
      text,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    input.value = "";
    toggleReplyInput(postId, commentId); // Hide the input after posting
    loadReplies(postId, commentId);
  }

  function toggleComments(id) {
    const box = document.getElementById(`comments-${id}`);
    box.style.display = box.style.display === "none" ? "block" : "none";
  }

  function toggleReplyInput(postId, commentId) {
    const inputBox = document.getElementById(`reply-input-${postId}-${commentId}`);
    inputBox.style.display = inputBox.style.display === "none" ? "flex" : "none";
  }

  // === Search Filter ===
  searchBar.addEventListener("input", async e => {
    const q = e.target.value.toLowerCase();
    const snap = await db.collection("posts").orderBy("createdAt", "desc").get();
    feed.innerHTML = "";8
    
    if (snap.empty) {
      feed.innerHTML = "<div class='no-posts'><i class='fas fa-search'></i><p>No posts found matching your search.</p></div>";
      return;
    }
    
    let foundPosts = false;
    
    snap.forEach(doc => {
      const post = doc.data();
      const match =
        (post.author && post.author.toLowerCase().includes(q)) ||
        (post.campus && post.campus.toLowerCase().includes(q)) ||
        (post.text && post.text.toLowerCase().includes(q));
        
      if (match) {
        foundPosts = true;
        
        // Format post time
        let postTime = "";
        if (post.createdAt) {
          const date = post.createdAt.toDate();
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);
          
          if (diffMins < 1) {
            postTime = "Just now";
          } else if (diffMins < 60) {
            postTime = `${diffMins} min ago`;
          } else if (diffHours < 24) {
            postTime = `${diffHours} hr ago`;
          } else if (diffDays < 7) {
            postTime = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
          } else {
            postTime = date.toLocaleDateString();
          }
        }

        const div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `
          <div class="post-header">
            <img src="${post.profilePic || 'https://via.placeholder.com/50'}" alt="Profile"/>
            <div class="post-user-info">
              <h4>${post.author}</h4>
              <p>${post.campus || ""} • ${postTime}</p>
            </div>
          </div>
          <div class="post-content">
            <p>${post.text}</p>
            ${post.imageUrl ? `<img src="${post.imageUrl}" class="post-image" onclick="openImageModal('${post.imageUrl}')" loading="lazy" alt="post image"/>` : ""}
          </div>
        `;
        feed.appendChild(div);
      }
    });
    
    if (!foundPosts) {
      feed.innerHTML = "<div class='no-posts'><i class='fas fa-search'></i><p>No posts found matching your search.</p></div>";
    }
  });
</script>
<script>
if(!window.navNotifLoaded){
  window.navNotifLoaded = true;

  const db = firebase.firestore();
  const auth = firebase.auth();

  const badge = document.getElementById('notifBadge');
  const bell = document.getElementById('notifBell');
  const dropdown = document.getElementById('notifDropdown');
  const list = document.getElementById('notifList');
  const emptyMsg = document.getElementById('notifEmpty');
  const sound = document.getElementById('notifSound');

  let currentUser=null;
  let previousCount=0;
  let previousSentRequests=[];
  let oppTimestamp = localStorage.getItem("oppTimestamp") || null;  // detect only new opportunities

// Replace the old unlock line with this completely silent one const unlockSound = () => {   sound.muted = true;   sound.play().then(() => {     sound.pause();     sound.currentTime = 0;     sound.muted = false;   }).catch(() => {});   document.removeEventListener('click', unlockSound); }; document.addEventListener('click', unlockSound);

  bell.addEventListener('click', e => {
    e.preventDefault();
    dropdown.style.display = dropdown.style.display==='none'?'block':'none';
  });

  auth.onAuthStateChanged(user=>{
    if(!user) return;
    currentUser=user;
    initNotifications();
  });

  async function initNotifications(){

    // ---------- USER NOTIFICATIONS ----------
    db.collection('users').doc(currentUser.uid).onSnapshot(async doc=>{
      const data = doc.data()||{};
      const received = data.receivedRequests||[];
      const sent = data.sentRequests||[];
      const connections = data.connections||[];

      let newlyAccepted=[];
      if(previousSentRequests.length>0){
        newlyAccepted = previousSentRequests.filter(uid=>!sent.includes(uid) && connections.includes(uid));
      }
      previousSentRequests = [...sent];

      const chatSnap = await db.collection('chats')
        .where('users','array-contains',currentUser.uid)
        .get();

      const unreadCounts = await Promise.all(chatSnap.docs.map(async chatDoc=>{
        const chatData = chatDoc.data();
        const partnerId = chatData.users.find(u=>u!==currentUser.uid);
        const unreadSnap = await chatDoc.ref.collection('messages')
          .where('senderId','==',partnerId)
          .where('seen','==',false).get();
        return unreadSnap.size;
      }));

      const total = received.length + unreadCounts.reduce((a,b)=>a+b,0) + newlyAccepted.length;

      badge.textContent = total>99?'99+':total;
      badge.style.display = total>0?'inline-block':'none';

      if(total>previousCount && previousCount!==0){
        sound.currentTime=0; sound.play().catch(()=>{});
        bell.querySelector('i').classList.add('fa-shake');
        setTimeout(()=>bell.querySelector('i').classList.remove('fa-shake'),800);
      }
      previousCount=total;
      localStorage.setItem("previousCount", total);

      renderDropdownNotifications(received,newlyAccepted,chatSnap);
    });

    // ---------- OPPORTUNITIES ----------
    db.collection('opportunities')
      .orderBy('timestamp','desc')
      .limit(1)
      .onSnapshot(snap=>{
        if(snap.empty) return;

        const doc = snap.docs[0];
        const data = doc.data();

        // Only trigger for BRAND NEW opportunity
        if(oppTimestamp === data.timestamp) return;
        oppTimestamp = data.timestamp;
localStorage.setItem("oppTimestamp", data.timestamp);
        prependDropdownItem({
          type:'opportunity',
          id:doc.id,
          title:data.title,
          msg:'New opportunity posted'
        });

        incrementBadge();
      });
  }


  // ---------- RENDER ALL NOTIFICATIONS ----------
  function renderDropdownNotifications(received,newlyAccepted,chats){
    list.innerHTML='';
    let hasNotif=false;

    // RECEIVED REQUESTS
    received.forEach(async uid=>{
      const userDoc = await db.collection('users').doc(uid).get();
      if(!userDoc.exists) return;
      prependDropdownItem({
        type:'request',
        uid,
        name:userDoc.data().name,
        photo:userDoc.data().photoUrl,
        msg:'Sent you a connection request'
      });
      hasNotif=true;
    });

    // ACCEPTED REQUESTS
    newlyAccepted.forEach(async uid=>{
      const userDoc = await db.collection('users').doc(uid).get();
      prependDropdownItem({
        type:'accepted',
        uid,
        name:userDoc.data().name,
        photo:userDoc.data().photoUrl,
        msg:'Accepted your request'
      });
      hasNotif=true;
    });

    // MESSAGES
    chats.docs.forEach(async chatDoc=>{
      const chatData = chatDoc.data();
      const partnerId = chatData.users.find(u=>u!==currentUser.uid);

      const unreadSnap = await chatDoc.ref.collection('messages')
        .where('senderId','==',partnerId)
        .where('seen','==',false).get();

      if(unreadSnap.size>0){
        const partnerDoc = await db.collection('users').doc(partnerId).get();
        prependDropdownItem({
          type:'message',
          uid:partnerId,
          chatId:chatDoc.id,
          name:partnerDoc.data().name,
          photo:partnerDoc.data().photoUrl,
          msg:chatData.lastMessage||'Sent a message'
        });
        hasNotif=true;
      }
    });

    emptyMsg.style.display = hasNotif?'none':'block';
  }


  // ---------- SINGLE NOTIFICATION ITEM ----------
  function prependDropdownItem(notif){
    const div = document.createElement('div');
    div.className='notificationItem';
    div.dataset.type=notif.type;

    let img = notif.photo ? `<img src="${notif.photo}">` : '<i class="fas fa-bell"></i>';

    div.innerHTML = `
      <div>${img}</div>
      <div class="notificationContent">
        <div class="notificationTitle">${notif.name || notif.title || ''}</div>
        <div class="notificationMsg">${notif.msg || ''}</div>
      </div>
    `;

    // CLICK REDIRECT LOGIC
    div.onclick = () => {
      if(notif.type === 'message'){
        window.location.href = `chat.html?with=${notif.uid}`;
      }
      else if(notif.type === 'opportunity'){
        window.location.href = `opportunity.html?id=${notif.id}`;
      }
      else if(notif.type === 'request' || notif.type === 'accepted'){
        window.location.href = `network.html`;
      }
    };

    // ACCEPT / DECLINE BUTTONS
    if(notif.type==='request'){
      const actions=document.createElement('div');
      actions.className='notifActions';

      const btnAccept=document.createElement('button');
      btnAccept.className='btn-small btnAccept';
      btnAccept.textContent='Accept';
      btnAccept.onclick = async e=>{
        e.stopPropagation();
        await db.collection('users').doc(currentUser.uid).update({
          connections: firebase.firestore.FieldValue.arrayUnion(notif.uid),
          receivedRequests: firebase.firestore.FieldValue.arrayRemove(notif.uid)
        });
        await db.collection('users').doc(notif.uid).update({
          connections: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
          sentRequests: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
        });
        div.remove();
      };

      const btnDecline=document.createElement('button');
      btnDecline.className='btn-small btnDecline';
      btnDecline.textContent='Decline';
      btnDecline.onclick = async e=>{
        e.stopPropagation();
        await db.collection('users').doc(currentUser.uid).update({
          receivedRequests: firebase.firestore.FieldValue.arrayRemove(notif.uid)
        });
        await db.collection('users').doc(notif.uid).update({
          sentRequests: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
        });
        div.remove();
      };

      actions.appendChild(btnAccept);
      actions.appendChild(btnDecline);
      div.appendChild(actions);
    }

    list.prepend(div);
  }


  function incrementBadge(){
    previousCount++;
    badge.textContent = previousCount > 99 ? '99+' : previousCount;
    badge.style.display='inline-block';
    sound.currentTime=0; sound.play().catch(()=>{});
    bell.querySelector('i').classList.add('fa-shake');
    setTimeout(()=> bell.querySelector('i').classList.remove('fa-shake'),800);
  }
}
</script>
</body>
</html>
